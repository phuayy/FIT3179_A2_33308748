{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "description": "Map → Agent → Team Sankey for VCT Champions 2025",
  "background": "transparent",
  "padding": 5,
  "width": 980,
  "height": 520,

  "data": [
    {
      "name": "links",
      "url": "https://raw.githubusercontent.com/phuayy/FIT3179_A2_33308748/refs/heads/main/data/sankey_edges_map_agent_team.csv",
      "format": { "type": "csv" },
      "transform": [
        { "type": "formula", "as": "value", "expr": "toNumber(datum.value)" },
        { "type": "identifier", "as": "id" }
      ]
    },
    {
      "name": "sankey_calc",
      "source": "links",
      "transform": [
        {
          "type": "sankey",
          "nodeKey": "datum.id",
          "source": "datum.source",
          "target": "datum.target",
          "value": "datum.value",
          "units": "value",
          "nodeAlign": "left",
          "nodeWidth": 12,
          "nodePadding": 8,
          "iterations": 32,
          "as": ["sankey_nodes", "sankey_links"]
        }
      ]
    }
  ],

  "marks": [
    {
      "type": "path",
      "from": { "data": "sankey_links" },
      "encode": {
        "update": {
          "stroke": { "value": "#FF4655" },
          "strokeOpacity": { "value": 0.45 },
          "strokeWidth": { "field": "width" },
          "fill": { "value": null },
          "tooltip": {
            "signal": "replace(datum.source, /^(m:|a:|t:)/, '') + ' → ' + replace(datum.target, /^(m:|a:|t:)/, '') + ': ' + format(datum.value, ',')"
          }
        },
        "hover": { "strokeOpacity": { "value": 0.8 } }
      },
      "transform": [ { "type": "linkpath", "shape": "sankey" } ]
    },

    {
      "type": "rect",
      "from": { "data": "sankey_nodes" },
      "encode": {
        "update": {
          "x":   { "field": "x0" },
          "x2":  { "field": "x1" },
          "y":   { "field": "y0" },
          "y2":  { "field": "y1" },
          "fill": {
            "signal": "startsWith(datum.name, 'm:') ? '#475569' : (startsWith(datum.name, 'a:') ? '#FF4655' : '#94a3b8')"
          },
          "fillOpacity": { "value": 0.9 },
          "stroke": { "value": "white" },
          "strokeWidth": { "value": 0.5 },
          "tooltip": {
            "signal": "replace(datum.name, /^(m:|a:|t:)/, '') + ': ' + format(datum.value, ',')"
          }
        }
      }
    },

    {
      "type": "text",
      "from": { "data": "sankey_nodes" },
      "encode": {
        "update": {
          "x": { "signal": "datum.x1 + 6" },
          "y": { "signal": "(datum.y0 + datum.y1) / 2" },
          "align": { "value": "left" },
          "baseline": { "value": "middle" },
          "fontSize": { "value": 11 },
          "fill": { "value": "#e2e8f0" },
          "text": { "signal": "replace(datum.name, /^(m:|a:|t:)/, '')" }
        }
      }
    }
  ],

  "config": {
    "view": { "stroke": null }
  }
}
