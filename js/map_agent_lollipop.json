{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Most-played agents on a selected map by joining player stats to maps via match_id (Top 10).",
  "width": "container",
  "height": 420,
  "background": "transparent",

  "data": {
    "name": "players",
    "url": "https://raw.githubusercontent.com/phuayy/FIT3179_A2_33308748/refs/heads/main/data/detailed_matches_player_stats.csv",
    "format": { "type": "csv" }
  },

  "params": [
    { "name": "MapName", "value": "Ascent" }
  ],

  "transform": [
    {
      "lookup": "match_id",
      "from": {
        "data": {
          "url": "https://raw.githubusercontent.com/phuayy/FIT3179_A2_33308748/refs/heads/main/data/detailed_matches_maps.csv",
          "format": { "type": "csv" }
        },
        "key": "match_id",
        "fields": ["map_name"]
      }
    },

    { "filter": "isValid(datum.map_name) && isValid(datum.agent)" },

    { "calculate": "lower(trim(datum.map_name))", "as": "MapNorm" },
    { "calculate": "lower(trim(MapName))", "as": "MapParamNorm" },
    { "filter": "datum.MapNorm === datum.MapParamNorm" },

    { "calculate": "trim(datum.agent)", "as": "AgentRaw" },
    { "calculate": "upper(slice(datum.AgentRaw,0,1)) + lower(slice(datum.AgentRaw,1))", "as": "Agent" },

    { "aggregate": [{ "op": "count", "as": "appearances" }], "groupby": ["Agent", "AgentRaw"] },

    {
      "window": [{ "op": "rank", "as": "rank" }],
      "sort": [{ "field": "appearances", "order": "descending" }]
    },
    { "filter": "datum.rank <= 5" },

    {
      "calculate": "lower(replace(replace(datum.AgentRaw, /[^A-Za-z0-9]+/g, '_'), /_+/g, '_'))",
      "as": "agent_slug"
    },
    { "calculate": "'images/agents/' + datum.agent_slug + '.jpg'", "as": "agent_img" }
  ],

    "layer": [
    {
        "mark": { "type": "rule", "strokeWidth": 1.5 },
        "encoding": {
        "y": {
            "field": "Agent", "type": "nominal",
            "sort": "-x", "title": null,
            "axis": { "labelColor": "white" }
        },
        "x": {
            "field": "appearances", "type": "quantitative",
            "title": "Appearances",
            "axis": { "labelColor": "white", "titleColor": "white" },
            "scale": { "zero": true, "nice": true }
        },
        "x2": { "value": 0 },
        "color": { "value": "#FF4655" }
        }
    },

    {
        "mark": {
        "type": "point",
        "shape": "circle",
        "filled": true,
        "size": 530,
        "color": "#0b0f17",
        "stroke": "#FF4655",
        "strokeWidth": 1.2
        },
        "encoding": {
        "y": { "field": "Agent", "type": "nominal", "sort": "-x" },
        "x": { "field": "appearances", "type": "quantitative" }
        }
    },

    {
        "mark": { "type": "image", "width": 48, "height": 48 },
        "encoding": {
        "y": { "field": "Agent", "type": "nominal", "sort": "-x" },
        "x": { "field": "appearances", "type": "quantitative" },
        "url": { "field": "agent_img" },
        "tooltip": [
            { "field": "Agent", "type": "nominal" },
            { "field": "appearances", "type": "quantitative", "title": "Appearances" }
        ]
        }
    },

    {
        "mark": { "type": "text", "align": "left", "dx": 30, "baseline": "middle", "fill": "#e5e7eb" },
        "encoding": {
        "y": { "field": "Agent", "type": "nominal", "sort": "-x" },
        "x": { "field": "appearances", "type": "quantitative" },
        "text": { "field": "appearances", "type": "quantitative" }
        }
    }
    ],

  "config": {
    "view": { "stroke": null },
    "axis": { "gridColor": "#334155", "labelColor": "white", "titleColor": "white" }
  }
}
